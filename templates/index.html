<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>DEcoCamp ‚Äî A Greener Tommorow!</title>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<style>
    :root { --primary-color: #3b82f6; --primary-hover: #2563eb; --bg-dark: #0f172a; --bg-light: #1e293b; --text-color: #f1f5f9; --text-muted: #94a3b8; --border-color: rgba(148,163,184,0.2); --success-color: #22c55e; --danger-color: #ef4444; --danger-hover: #dc2626; --radius: 12px; --max-width: 99%; --ease: cubic-bezier(.2,.9,.3,1); --ai-gradient: linear-gradient(135deg, #6366f1, #a855f7, #ec4899); }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth;}
    body { font-family: 'Inter',sans-serif; background: var(--bg-dark); color: var(--text-color); -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; line-height: 1.6; overflow-x: hidden; }
    .navbar { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: transparent; backdrop-filter: blur(10px); border-bottom: 1px solid var(--border-color); padding: 0 1rem; }
    .nav-inner { display: flex; align-items: center; justify-content: space-between; max-width: var(--max-width); margin: 0 auto; height: 70px; }
    .brand { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 20px; color: var(--text-color); text-decoration: none; }
    .logo { width: 40px; height: 40px; border-radius: 8px; background: linear-gradient(135deg,var(--primary-color),#60a5fa); display: flex; align-items: center; justify-content: center; font-weight: 800; color: #fff; box-shadow: 0 4px 12px rgba(59,130,246,0.3); }
    .brand-text div:first-child { font-size: 16px; }
    .brand-text div:last-child { font-size: 12px; color: var(--text-muted); font-weight: 500; }
    nav { display: flex; align-items: center; gap: .5rem; }
    .navlink { text-decoration: none; color: var(--text-muted); padding: 8px 12px; border-radius: 8px; transition: color .2s,background .2s; font-weight: 600; }
    .navlink:hover { color: var(--text-color); background: rgba(255,255,255,0.05); }
    .navlink.active { color: var(--primary-color); background: rgba(59,130,246,0.1); }
    .cta { background: var(--primary-color); color: #fff; border: none; padding: 10px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; transition: background .2s var(--ease),transform .2s var(--ease); margin-left: 1rem; font-size: 14px; }
    .cta:hover { background: var(--primary-hover); }
    section { max-width: var(--max-width); margin: 0 auto; padding: 100px 1rem 40px; display: none; }
    section.active { display: block; }
    h1, h2, h3, h4 { color: var(--text-color); margin-bottom: 1rem; }
    p { color: var(--text-muted); margin-bottom: 1rem; }
    .home-layout { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; align-items: center; }
    .home-hero h1 { font-size: 2.5rem; line-height: 1.2; }
    #ndhome { font-size: 1.2rem; font-style: italic; padding: 2rem; border-left: 3px solid var(--primary-color); background: var(--bg-light); border-radius: var(--radius); text-align: center; }
    .account-container { display: flex; flex-direction: column; align-items: center; gap: 2rem; padding: 2rem; background: var(--bg-light); border-radius: var(--radius); }
    .toggle-buttons { display: flex; gap: 1rem; background: var(--bg-dark); padding: 8px; border-radius: 8px; }
    .toggle-buttons button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 6px; background: none; color: var(--text-muted); font-weight: 600; transition: .2s; }
    .toggle-buttons button.active, .toggle-buttons button:hover { background: var(--primary-color); color: #fff; }
    .auth-form { display: none; flex-direction: column; gap: 1rem; width: 100%; max-width: 350px; }
    .auth-form.active { display: flex; }
    .form-group { position: relative; margin-bottom: 1rem; }
    .form-group .toggle-password { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-muted); }
    .otp-group { display: flex; gap: .5rem; align-items: center; }
    .otp-group input { flex-grow: 1; }
    .otp-btn { padding: 10px 15px; font-size: .9rem; flex-shrink: 0; background: var(--primary-color); color: #fff; border: none; border-radius: 8px; cursor: pointer; transition: background .2s,opacity .2s; }
    .otp-btn:hover { background: var(--primary-hover); }
    .otp-btn:disabled { background: var(--text-muted); opacity: .7; cursor: not-allowed; }
    #contact input, #contact textarea { width: 100%; padding: 10px 12px; border: 1px solid #2d3748; border-radius: 6px; background: #1e293b; color: #f1f5f9; }
    input::placeholder, textarea::placeholder, select::placeholder { color: #b0b8c9 !important; opacity: 1; }
    #contactForm { max-width: 600px; margin: 0 auto; }
    #contact input:focus, #contact textarea:focus { border-color: #3b82f6; outline: none; }
    .campaign-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 2rem; }
    .campaign-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(300px,1fr)); gap: 1.5rem; }
    .campaign-card { background: var(--bg-light); border-radius: var(--radius); padding: 1.5rem; border: 1px solid var(--border-color); transition: transform .2s,box-shadow .2s; position: relative; display: flex; flex-direction: column; }
    .campaign-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.2); }
    .campaign-card h4 { color: var(--text-color); font-size: 1.25rem; }
    .campaign-card p { flex-grow: 1; font-size: .9rem; }
    .read-more-btn { background: transparent; color: var(--primary-color); border: none; cursor: pointer; font-weight: 600; font-size: 0.9rem; padding: 0 4px; display: inline-block; margin-left: 5px; }
    .read-more-btn:hover { text-decoration: underline; opacity: 0.8; }
    .card-footer { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); display: flex; align-items: center;}
    .campaign-tag { display: inline-block; background: rgba(59,130,246,0.1); color: var(--primary-color); padding: 4px 10px; border-radius: 16px; font-size: .8rem; font-weight: 600; text-transform: uppercase; cursor: pointer; border: none; }
    .campaign-tag:hover { background: rgba(59,130,246,0.2); }
    .campaign-id { color: var(--text-muted); font-size: .75rem; font-weight: bold; position: absolute; top: 1rem; right: 1rem; }
    .delete-btn { background: #ef4444; color: #fff; border: none; padding: 6px 12px; font-size: .8rem; border-radius: 6px; cursor: pointer; margin-top: 0; transition: background .2s; }
    .delete-btn:hover { background: #dc2626; }
    .form-container { max-width: 120%; margin: 0 auto; background: var(--bg-light); padding: 0.75rem; border-radius: var(--radius); border: 1px solid var(--border-color); }
    .form-container h1 { text-align: center; color: var(--text-color); }
    .form-container p.intro { text-align: center; max-width: 600px; margin: 0 auto 2rem; }
    .form-layout { display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; }
    .form input, .form select, .form textarea, .auth-form input { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--bg-dark); color: var(--text-color); outline: none; transition: border-color .2s,box-shadow .2s; font-size: 1rem; }
    .form input:focus, .form select:focus, .form textarea:focus, .auth-form input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59,130,246,0.3); }
    .form select option { background: var(--bg-dark); color: var(--text-color); }
    .form-group label { display: block; margin-bottom: .5rem; font-weight: 600; font-size: .9rem; color: var(--text-muted); }
    .form-buttons { display: flex; gap: 1rem; margin-top: 1.5rem; }
    .submit-btn, .reset-btn { flex: 1; padding: 12px; font-size: 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; transition: .2s; }
    .submit-btn { background: var(--primary-color); color: #fff; }
    .submit-btn:hover:not(:disabled) { background: var(--primary-hover); }
    .submit-btn:disabled { background: var(--text-muted); opacity: .7; cursor: not-allowed; }
    .reset-btn { background: var(--bg-light); border: 1px solid var(--border-color); color: var(--text-color); }
    .reset-btn:hover { background: var(--bg-dark); }
    .form-row label { margin-bottom: 0.3rem; }
    .form-row-horizontal { display: flex; gap: 1rem; }
    .form-row-horizontal .form-half { flex: 1 1 0; display: flex; flex-direction: column; }
    .form-row input[type="date"], .form-row input[type="time"] { min-width: 120px; margin-bottom: 0.5rem; }
    .form-sidebar { background: var(--bg-dark); padding: 1.5rem; border-radius: var(--radius); }
    .campaign-category-wrapper { margin-bottom: 3rem; }
    .view-all-btn { display: inline-block; margin-top: 1rem; margin-left: 0; }
    #backToAllBtn { display: none; margin-bottom: 2rem; margin-left: 0; }
    .campaign-card.hidden { display: none; }
    .campaign-card.search-hidden { display: none; }
    .controls-container { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center; }
    .search-wrapper, .sort-wrapper { display: flex; align-items: center; position: relative; }
    .search-wrapper { flex: 1; min-width: 250px; }
    .sort-wrapper { min-width: 220px; gap: 8px; }
    .search-wrapper input { width: 100%; padding: 10px 16px 10px 42px; background-color: var(--bg-light); border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-color); font-size: 0.95rem; transition: all 0.2s ease; }
    .search-wrapper input:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
    .search-wrapper::before { content: ''; position: absolute; left: 14px; width: 18px; height: 18px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='18' height='18' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cpath d='m21 21-4.35-4.35'%3E%3C/path%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; pointer-events: none; }
    .sort-wrapper select { flex: 1; padding: 10px 38px 10px 16px; background-color: var(--bg-light); border: 1px solid var(--border-color); border-radius: 20px; color: var(--text-color); font-size: 0.95rem; transition: all 0.2s ease; -webkit-appearance: none; -moz-appearance: none; appearance: none; cursor: pointer; }
    .sort-wrapper select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
    .sort-wrapper::before { content: ''; position: absolute; right: 60px; width: 16px; height: 16px; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2.5' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E"); background-size: contain; background-repeat: no-repeat; pointer-events: none; z-index: 1; }
    .sort-direction-btn { background: transparent; border: none; cursor: pointer; padding: 8px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; height: 40px; width: 40px; min-width: 40px; border-radius: 6px; }
    .sort-direction-btn:hover { background-color: rgba(255, 255, 255, 0.1); }
    .sort-direction-btn svg { transition: transform 0.3s ease; display: block; width: 22px; height: 22px; }
    .sort-direction-btn.descending svg { transform: rotate(180deg); }
    .controls-container form { margin: 0; width: auto; flex: 1; }
    .table-responsive { width: 100%; overflow-x: auto; background: var(--bg-light); border-radius: var(--radius); padding: 1rem; border: 1px solid var(--border-color); }
    .pending-events-table { width: 100%; border-collapse: collapse; text-align: left; }
    .pending-events-table th, .pending-events-table td { padding: 12px 15px; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    .pending-events-table th { background-color: var(--bg-dark); font-weight: 700; text-transform: uppercase; font-size: .85rem; color: var(--text-muted); }
    .pending-events-table tr:last-child td { border-bottom: none; }
    .pending-events-table tr:hover { background-color: rgba(255, 255, 255, 0.03); }
    .pending-events-table input, .pending-events-table textarea, .pending-events-table select { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-dark); color: var(--text-color); font-size: 0.9rem; min-width: 130px; }
    .actions-cell { display: flex; gap: 0.5rem; align-items: center; flex-direction: column; }
    .action-btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.9rem; transition: background .2s; color: #fff; }
    .approve-btn { background-color: var(--primary-color); }
    .approve-btn:hover { background-color: var(--primary-hover); }
    .decline-btn { background-color: var(--danger-color); }
    .decline-btn:hover { background-color: var(--danger-hover); }
    .language-dropdown { padding: 8px 0; }
    .lang-option { padding: 12px 16px; cursor: pointer; color: var(--text-color); transition: background .2s; font-weight: 500; font-size: 0.95rem; }
    .lang-option:hover { background: rgba(59, 130, 246, 0.1); color: var(--primary-color); }
    .lang-option:first-child { border-radius: 8px 8px 0 0; }
    .lang-option:last-child { border-radius: 0 0 8px 8px; }
    .like-btn { background: transparent; border: none; cursor: pointer; padding: 4px; display: inline-flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
    .like-btn svg { fill: none; stroke: #9ca3af; stroke-width: 2; transition: all 0.2s ease; width: 22px; height: 22px; }
    .like-btn:hover svg { stroke: #ef4444; transform: scale(1.15); }
    .like-btn.liked svg { fill: #ef4444; stroke: #ef4444; }
    .like-count { font-size: 0.9rem; font-weight: 600; color: var(--text-muted); min-width: 18px; text-align: center; }
    .like-count + .campaign-tag { margin-left: 12px; }
    .share-btn { background: transparent; border: none; padding: 6px; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; border-radius: 6px; color: #9ca3af; cursor: pointer; text-decoration: none; }
    .share-btn:hover { background-color: rgba(255, 255, 255, 0.1); transform: scale(1.15); color: #6b7280; }
    .share-btn svg { display: block; width: 20px; height: 20px; }
    .ai-gen-btn { background: var(--ai-gradient); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; margin-bottom: 8px; transition: opacity 0.2s, transform 0.2s; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
    .ai-gen-btn:hover { opacity: 0.9; transform: translateY(-1px); }
    .ai-gen-btn:disabled { opacity: 0.7; cursor: not-allowed; transform: none; }
    .ai-options-container { display: none; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1.5rem; animation: fadeIn 0.3s ease; width: 100%; }
    .ai-options-container.show { display: grid; }
    .ai-option-card { border-radius: 8px; padding: 0.75rem; cursor: pointer; transition: all 0.2s ease; position: relative; overflow: hidden; border: 1px solid transparent; color: white; min-width: 0; word-wrap: break-word; overflow-wrap: break-word; font-size: 0.75rem; }
    .ai-option-card:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
    .ai-card-desc1 { background: linear-gradient(135deg, #1e3a8a, #2563eb); border-color: #3b82f6; }
    .ai-card-desc2 { background: linear-gradient(135deg, #064e3b, #059669); border-color: #10b981; }
    .ai-card-desc3 { background: linear-gradient(135deg, #4c1d95, #7c3aed); border-color: #8b5cf6; }
    .ai-card-desc4 { background: linear-gradient(135deg, #9a3412, #ea580c); border-color: #f97316; }
    .ai-option-card h5 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; color: rgba(255,255,255,0.9); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
    .ai-option-card p { font-size: 0.8rem; color: rgba(255,255,255,0.95); margin-bottom: 0; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 10; -webkit-box-orient: vertical; overflow: hidden; }
    .ai-tag { font-size: 0.6rem; padding: 2px 4px; border-radius: 4px; background: rgba(0,0,0,0.2); }
    .chat-drawer { position: fixed; top: 0; right: -450px; width: 400px; height: 100%; height: 100dvh; background: var(--bg-light); box-shadow: -5px 0 35px rgba(0,0,0,0.6); z-index: 2000; transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1); display: flex; flex-direction: column; border-left: 1px solid var(--border-color); }
    .chat-drawer.open { right: 0; }
    .chat-header { padding: 15px 20px; background: var(--bg-dark); border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
    .chat-header h3 { margin: 0; font-size: 1.1rem; color: var(--text-color); }
    .close-chat { background: none; border: none; color: var(--text-muted); font-size: 1.8rem; line-height: 1; cursor: pointer; padding: 0 5px; transition: color 0.2s; }
    .close-chat:hover { color: var(--text-color); }
    .chat-iframe { flex: 1; width: 100%; border: none; background: var(--bg-dark); }
    @media (max-width: 480px) { .chat-drawer { width: 100%; right: -100%; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .alert-bar { position: fixed; top: 70px; left: 0; right: 0; z-index: 999; padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; background: linear-gradient(135deg, #ef4444, #dc2626); color: #fff; font-weight: 600; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); transform: translateY(-100%); opacity: 0; transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease; pointer-events: none; }
    .alert-bar.show { transform: translateY(0); opacity: 1; pointer-events: all; }
    .alert-bar.success { background: linear-gradient(135deg, #22c55e, #16a34a); box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3); }
    .alert-bar.info { background: linear-gradient(135deg, #3b82f6, #2563eb); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
    .alert-bar.warning { background: linear-gradient(135deg, #f59e0b, #d97706); box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
    .alert-content { display: flex; align-items: center; justify-content: center; gap: 12px; flex-direction: row; width: 100%; }
    .alert-text { font-size: 0.95rem; line-height: 1.4; text-align: center; }
    .alert-buttons { display: flex; gap: 10px; flex-shrink: 0; align-items: center; justify-content: center; white-space: nowrap; }
    .alert-close { background: none; border: none; color: #fff; cursor: pointer; font-size: 1.5rem; padding: 0; margin-left: 1.5rem; transition: opacity 0.2s; flex-shrink: 0; }
    .alert-close:hover { opacity: 0.8; }
    .alert-action-btn { background: rgba(255, 255, 255, 0.2); border: 1px solid rgba(255, 255, 255, 0.4); color: #fff; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: background 0.2s, border-color 0.2s; white-space: nowrap; }
    .alert-action-btn:hover { background: rgba(255, 255, 255, 0.3); border-color: rgba(255, 255, 255, 0.6); }
    .alert-action-btn:active { background: rgba(255, 255, 255, 0.25); }
    @media (max-width: 768px) {
        .navbar { position: relative; } /* Corrected: Navbar is relative on mobile to prevent overlay */
        section { padding-top: 2rem; } /* Adjusted padding since navbar is not fixed */
        .nav-inner { flex-wrap: wrap; height: auto; padding-top: 10px; padding-bottom: 10px; }
        nav { display: flex; width: 100%; flex-wrap: wrap; justify-content: center; margin-top: 10px; }
        .cta { margin-left: 0; width: auto; text-align: center; }
        .home-layout, .form-layout { grid-template-columns: 1fr; }
        .home-hero h1 { font-size: 2rem; }
        .alert-bar { top: 70px; padding: 0.75rem 1rem; }
        .alert-content { flex-direction: column; align-items: flex-start; }
        .alert-close { margin-left: 0; margin-top: 0.5rem; }
        .ai-options-container { grid-template-columns: 1fr 1fr; }
        .sort-wrapper::before { right: 14px; }
    }
    #calendar { background: var(--bg-light); padding: 20px; border-radius: 12px; border: 1px solid var(--border-color); max-width: 1000px; margin: 20px auto; color: var(--text-color); }
    .fc-theme-standard td, .fc-theme-standard th { border-color: var(--border-color); }
    .fc .fc-toolbar-title { font-size: 1.5em; font-weight: 700; color: var(--text-color); }
    .fc .fc-button-primary { background-color: var(--primary-color); border-color: var(--primary-color); }
    .fc .fc-button-primary:hover { background-color: var(--primary-hover); border-color: var(--primary-hover); }
    .fc-daygrid-day-number { color: var(--text-muted); text-decoration: none; }
    .fc-col-header-cell-cushion { color: var(--text-color); text-decoration: none; }
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
    .dash-card { background: var(--bg-light); padding: 1.5rem; border-radius: var(--radius); border: 1px solid var(--border-color); }
    .leaderboard-list { list-style: none; padding: 0; margin-top: 1rem; }
    .leaderboard-item { display: flex; align-items: center; gap: 10px; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
    .leaderboard-rank { font-weight: bold; color: var(--primary-color); width: 25px; }
    .leaderboard-avatar { width: 30px; height: 30px; border-radius: 50%; }
</style>
</head>
<body>

<header class="navbar">
    <div class="nav-inner">
        <a href="#" class="brand" title="DEcoCamp">
            <div class="logo">EC</div>
            <div class="brand-text">
                <div>{{ translate('DEcoCamp') }}</div>
                <div>{{ translate('A Greener Tomorrow!') }}</div>
            </div>
        </a>
        <nav>
            <a class="navlink active" href="#home" data-section="home">{{ translate("Home") }}</a>
            <a class="navlink" href="#campaigns" data-section="campaigns">{{ translate("Campaigns") }}</a>
            <a class="navlink" href="#add" data-section="add">{{ translate("Add") }}</a>
            {% if isadmin %}
            <a class="navlink" href="#pending" data-section="pending">{{ translate("Pending") }}</a>
            {% endif %}
            <a class="navlink" href="#contact" data-section="contact">{{ translate("Contact") }}</a>
            <div class="language-selector" style="position: relative;">
                <button class="cta" id="languageBtn" style="margin: 0;">{{ translate("Change Language") }}</button>
                <div id="languageDropdown" class="language-dropdown" style="display: none; position: absolute; top: 100%; right: 0; background: var(--bg-light); border: 1px solid var(--border-color); border-radius: 8px; min-width: 220px; z-index: 1001; margin-top: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <div class="lang-option" data-lang="en">English / English (en)</div>
                    <div class="lang-option" data-lang="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä / Hindi (hi)</div>
                    <div class="lang-option" data-lang="te">‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å / Telugu (te)</div>
                    <div class="lang-option" data-lang="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤° / Kannada (kn)</div>
                    <div class="lang-option" data-lang="ml">‡¥Æ‡¥≤‡¥Ø‡¥æ‡¥≥‡¥Ç / Malayalam (ml)</div>
                    <div class="lang-option" data-lang="gu">‡™ó‡´Å‡™ú‡™∞‡™æ‡™§‡´Ä / Gujarati (gu)</div>
                    <div class="lang-option" data-lang="bn">‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ / Bengali (bn)</div>
                    <div class="lang-option" data-lang="pa">‡®™‡©∞‡®ú‡®æ‡®¨‡©Ä / Punjabi (pa)</div>
                    <div class="lang-option" data-lang="mr">‡§Æ‡§∞‡§æ‡§†‡•Ä / Marathi (mr)</div>
                    <div class="lang-option" data-lang="or">‡¨ì‡¨°‡¨º‡¨ø‡¨Ü / Odia (or)</div>
                </div>
            </div>
        </nav>
    </div>
</header>

<div id="alertBar" class="alert-bar">
    <div class="alert-content">
        <div style="display: flex; flex-direction: column; align-items: center; gap: 10px; flex: 1;">
            <span class="alert-text" id="alertText"></span>
            <div class="alert-buttons" id="alertButtons" style="display: none; gap: 10px;">
                <button class="alert-action-btn reload-btn" onclick="window.location.reload()" title="{{ translate('Reload') }}">{{ translate('Click here to reload') }}</button>
                <button class="alert-action-btn close-btn" onclick="closeAlert()" title="{{ translate('Close') }}">{{ translate('Close this message') }}</button>
            </div>
        </div>
    </div>
    <button class="alert-close" id="alertCloseBtn" onclick="closeAlert()" title="{{ translate('Close') }}">‚úï</button>
</div>

<div id="sideChatDrawer" class="chat-drawer">
    <div class="chat-header">
        <h3>{{ translate("Event Chat") }}</h3>
        <button class="close-chat" onclick="closeEventChat()">√ó</button>
    </div>
    <iframe id="globalChatIframe" class="chat-iframe"></iframe>
</div>

<main>
    <section id="home" class="active">
        <div class="home-layout">
            <div class="home-hero">
                <h1>{{ translate("Hey") }} {{ translate(fullname.split()[0], save_file=False) }}, {{ translate("Welcome to DEcoCamp!") }}</h1>
                <p>{{ translate("Join hands to protect our green planet. Start a campaign, plant hope for a brighter, cleaner tomorrow.") }}</p>
                <div id="ndhome"></div>
                <script>
                // FIX: Use relative path to avoid Mixed Content error
                fetch("/static/quotes.json").then(r=>r.json()).then(data=>{
                    const userLanguage = "{{ user_language }}" || "en";
                    const quoteEl = document.getElementById('ndhome');
                    const setQuote = () => {
                        const quoteKeys = Object.keys(data);
                        const randomQuoteKey = quoteKeys[Math.floor(Math.random() * quoteKeys.length)];
                        const quoteText = data[randomQuoteKey][userLanguage] || data[randomQuoteKey]["en"];
                        quoteEl.innerText = `{{ translate("Active Campaigns:") }} {{ active_events_length }}\n\n"${quoteText}"`;
                    }; setQuote(); setInterval(setQuote, 6000); });
                </script>
                {% if top_organizers %}
                <div class="dash-card" style="margin-top: 2rem;">
                    <h4>üèÜ {{ translate("Top Organizers") }}</h4>
                    <ul class="leaderboard-list">
                        {% for org in top_organizers %}
                        <li class="leaderboard-item">
                            <span class="leaderboard-rank">#{{ loop.index }}</span>
                            <img src="https://ui-avatars.com/api/?name={{ org.username }}&background=random&color=fff&size=128" class="leaderboard-avatar">
                            <div style="flex-grow: 1;">
                                <div style="font-weight: 600; font-size: 0.9rem;">{{ org.name }}</div>
                                <div style="font-size: 0.8rem; color: var(--text-muted);">{{ org.count }} {{ translate("Events") }}</div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                </div>
                {% endif %}
            </div>
            <div class="account-container">
                {% if c_user == "None" %}
                    <div class="toggle-buttons">
                        <button id="login-tab-btn" class="active">{{ translate("Login") }}</button>
                        <button id="signup-tab-btn">{{ translate("Sign Up") }}</button>
                    </div>
                    <form class="auth-form active" id="loginpage">
                        <div class="form-group">
                            <input type="text" name="loginusername" placeholder="{{ translate('Username or Email') }}" required />
                        </div>
                        <div class="form-group">
                            <input type="password" name="loginpassword" id="loginpassword" placeholder="{{ translate('Password') }}" required/>
                            <span class="toggle-password" onclick="togglePasswordVisibility('loginpassword')">üëÅÔ∏è</span>
                        </div>
                        <button type="submit" class="submit-btn">{{ translate("Login") }}</button>
                    </form>
                    <form class="auth-form" id="signuppage">
                        <div class="form-group"><input type="text" name="nameofuser" placeholder="{{ translate('Full Name') }}" maxlength="24" required /></div>
                        <div class="form-group"><input type="text" name="username" placeholder="{{ translate('Username') }}" maxlength="20" required /></div>
                        <div class="form-group otp-group">
                           <input type="email" name="email" id="email" placeholder="{{ translate('Email') }}" required />
                           <button type="button" id="sendOtpBtn" class="otp-btn">{{ translate("Send OTP") }}</button>
                        </div>
                        <div class="form-group"><input type="number" name="signupotp" placeholder="{{ translate('Enter OTP') }}" oninput="this.value=this.value.slice(0,4)" required /></div>
                        <div class="form-group">
                            <input type="password" name="password" id="signup_password" placeholder="{{ translate('Password') }}" required />
                            <span class="toggle-password" onclick="togglePasswordVisibility('signup_password')">üëÅÔ∏è</span>
                        </div>
                        <div class="form-group">
                            <input type="password" name="cpassword" id="signup_cpassword" placeholder="{{ translate('Confirm Password') }}" required />
                            <span class="toggle-password" onclick="togglePasswordVisibility('signup_cpassword')">üëÅÔ∏è</span>
                        </div>
                        <button type="submit" class="submit-btn">{{ translate("Sign Up") }}</button>
                    </form>
                {% else %}
                    <h3>{{ translate("Welcome") }}, {{ translate(fullname, save_file=False) }}!</h3>
                    <p>{{ translate("Username:") }} {{ c_user }}</p>
                    <p>{{ translate("Email:") }} {{ userdetails['email'] }}</p>
                    {% if userdetails['events'] != None %}
                    <p>{{ translate("Events: Total") }} {{ userdetails['events'].split(",") | length }} {{ translate("Events added by you.") }} </p>
                    <button class="otp-btn" onclick="viewyourevents('{{ c_user }}')">{{ translate("Click Here To View Your Events") }}</button>
                    {% else %}
                    <p>{{ translate("Events by you: No event added by you yet.") }}</p>
                    {% endif %}
                    <div class="form-buttons">
                        <button onclick="window.location.href='/user/{{ c_user }}'" class="submit-btn">{{ translate("View Profile") }}</button>
                        <button onclick="window.location.href='/clearsession';" class="delete-btn">{{ translate("Logout") }}</button>
                    </div>
                {% endif %}
            </div>
        </div>
        {% if isadmin %}
        <div style="margin-top: 3rem;">
            <h2>üõ†Ô∏è System Health (Admin)</h2>
            <div class="dashboard-grid">
                <div class="dash-card"><h3>{{ admin_stats['total_users'] }}</h3><p>Total Users</p></div>
                <div class="dash-card"><h3>{{ admin_stats['total_events'] }}</h3><p>Total Events</p></div>
                <div class="dash-card"><h3>{{ admin_stats['pending_requests'] }}</h3><p>Pending Requests</p></div>
                <div class="dash-card"><h3>{{ admin_stats['active_threads'] }}</h3><p>Active Threads</p></div>
            </div>
        </div>
        {% endif %}
    </section>

    <section id="campaigns">
        <div class="campaign-header">
            <div>
                <h2 id="campaignsTitle">{{ translate("Campaigns") }} ( {{ active_events_length }} )</h2>
                <p>{{ translate("Find campaigns to join or create your own.") }}</p>
            </div>
            <div class="toggle-buttons">
                <button id="listViewBtn" class="active" onclick="toggleView('list')">List View</button>
                <button id="calendarViewBtn" onclick="toggleView('calendar')">Calendar View</button>
            </div>
        </div>
        <div id="campaignsLoadingState" style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-muted); font-size: 1.1rem;">{{ translate("Loading campaigns...") }}</p>
        </div>
        <div id="campaignsContent" style="display: none;"></div>
        <div id="calendarView" style="display: none;">
            <div id="calendar"></div>
        </div>
    </section>

    <section id="pending">
        {% if isadmin %}
        <div id="pendingLoadingState" style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-muted); font-size: 1.1rem;">{{ translate("Loading pending events...") }}</p>
        </div>
        <div id="pendingContent" style="display: none;"></div>
        {% else %}
        <div style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-muted); font-size: 1.1rem;">{{ translate("Access denied. Admin privileges required.") }}</p>
        </div>
        {% endif %}
    </section>

    <section id="add">
        <div id="addFormLoadingState" style="text-align: center; padding: 3rem;">
            <p style="color: var(--text-muted); font-size: 1.1rem;">{{ translate("Loading form...") }}</p>
        </div>
        <div id="addFormContent" style="display: none;"></div>
    </section>

    <section id="contact">
        <div class="form-container">
            <h1>{{ translate("Contact Us") }}</h1>
            <p class="intro">
                {{ translate("Have a question or feedback? Send us a message, email: ") }} <a href="mailto:hu1243009@sjchs.edu.in">hu1243009@sjchs.edu.in</a>
            </p>
        </div>
    </section>
</main>

<script>
    const $ = s => document.querySelector(s);
    const $$ = s => document.querySelectorAll(s);
    const toggleDisplay = (el, show) => el && (el.style.display = show ? 'inline' : 'none');
    const toggleElements = (showEls, hideEls) => {
        showEls.forEach(el => toggleDisplay(el, true));
        hideEls.forEach(el => toggleDisplay(el, false));
    };

    function showAlert(message, type = 'info', duration = 5000, showButtons = false) {
        const alertBar = $('#alertBar');
        const alertText = $('#alertText');
        const alertButtons = $('#alertButtons');
        const alertCloseBtn = $('#alertCloseBtn');
        alertText.textContent = message;
        alertBar.classList.remove('success', 'info', 'warning', 'error');
        if (type !== 'info') alertBar.classList.add(type);
        if (type === 'success' && showButtons) {
            alertButtons.style.display = 'flex';
            alertCloseBtn.style.display = 'none';
            duration = 0;
        } else {
            alertButtons.style.display = 'none';
            alertCloseBtn.style.display = 'block';
        }
        alertBar.classList.add('show');
        if (duration > 0) setTimeout(closeAlert, duration);
    }

    const closeAlert = () => $('#alertBar')?.classList.remove('show');

    function openeventchat(eventid) {
        const drawer = $('#sideChatDrawer');
        const iframe = $('#globalChatIframe');
        iframe.src = `/group-chat/from-event/${eventid}`;
        drawer.classList.add('open');
    }

    function closeEventChat() {
        $('#sideChatDrawer').classList.remove('open');
        setTimeout(() => $('#globalChatIframe').src = '', 400);
    }

    function toggleDescription(id, action) {
        const shortDesc = $(`#desc-short-${id}`);
        const fullDesc = $(`#desc-full-${id}`);
        const moreBtn = $(`#read-more-btn-${id}`);
        const lessBtn = $(`#read-less-btn-${id}`);
        if (action === 'more') { toggleElements([fullDesc, lessBtn], [shortDesc, moreBtn]); }
        else { toggleElements([shortDesc, moreBtn], [fullDesc, lessBtn]); }
    }

    function filterCampaigns(searchInput) {
        const filter = searchInput.value.toLowerCase();
        const categoryWrapper = searchInput.closest('.campaign-category-wrapper');
        if (!categoryWrapper) return;
        categoryWrapper.querySelectorAll('.campaign-card').forEach(card => {
            card.classList.toggle('search-hidden', !card.innerText.toLowerCase().includes(filter));
        });
    }

    function declineEvent(eventId) {
        let reason = null;
        while (!reason || reason.trim() === "") {
            reason = prompt("{{ translate('A reason is required to decline this event:') }}");
            if (reason === null) { showAlert("{{ translate('Decline action cancelled.') }}", 'info'); return; }
        }
        window.location.href = `/decline_event/${eventId}/${encodeURIComponent(reason)}`;
    }

    window.asktodelete = id => {
        if (confirm("{{ translate('Are you sure?') }}")) { window.location.href = `deleteevent/${id}`; }
    };

    async function generateDescription() {
        {% if c_user == "None" %}
            showAlert("{{ translate('To avoid spam, we recommend you to please login before generating AI description.') }}", 'warning');
            return;
        {% endif %}
        const form = $('#addEventForm');
        const formData = new FormData(form);
        const requiredFields = ['eventname', 'location', 'category', 'eventstartdate', 'eventenddate', 'eventstarttime', 'eventendtime'];
        const missing = requiredFields.filter(key => !formData.get(key));
        if (missing.length > 0) {
            showAlert("{{ translate('Please fill in ALL fields (Name, Location, Category, Dates, Times) before generating.') }}", 'warning');
            return;
        }
        const btn = $('#aiBtn');
        const originalText = btn.innerHTML;
        const resultsContainer = $('#aiResults');
        btn.disabled = true;
        btn.innerHTML = '‚ú® {{ translate("Generating the descriptions please wait some seconds...") }}';
        resultsContainer.classList.remove('show');
        resultsContainer.innerHTML = '';
        try {
            const response = await fetch('/generate_ai_description', { method: 'POST', body: formData });
            if (!response.ok) throw new Error('Generation failed');
            const data = await response.json();
            const labels = {
                'desc1': '{{ translate("Formal") }}',
                'desc2': '{{ translate("Informal") }}',
                'desc3': '{{ translate("Promotional") }}',
                'desc4': '{{ translate("Entertaining") }}'
            };
            Object.keys(data).forEach(key => {
                const card = document.createElement('div');
                card.className = `ai-option-card ai-card-${key}`;
                card.innerHTML = `<h5>${labels[key] || key}</h5><p>${data[key]}</p>`;
                card.onclick = () => {
                    $('#descriptionField').value = data[key];
                    showAlert("{{ translate('Description updated!') }}", 'success');
                    $('#descriptionField').scrollIntoView({behavior: 'smooth', block: 'center'});
                };
                resultsContainer.appendChild(card);
            });
            $('#aiInstruction').style.display = 'block';
            resultsContainer.classList.add('show');
        } catch (error) {
            console.error('AI Error:', error);
            showAlert("{{ translate('Failed to generate descriptions. Please try again.') }}", 'warning');
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    }

    const contentLoaders = {
        campaigns: { loaded: false, callback: initializeCampaignListeners },
        addForm: { loaded: false, callback: initializeAddFormListeners },
        pending: { loaded: false, callback: initializePendingListeners }
    };

    function rerunScripts(container) {
        container.querySelectorAll('script').forEach(oldScript => {
            const newScript = document.createElement('script');
            oldScript.getAttributeNames().forEach(attr =>
                newScript.setAttribute(attr, oldScript.getAttribute(attr))
            );
            newScript.textContent = oldScript.textContent;
            oldScript.parentNode.replaceChild(newScript, oldScript);
        });
    }

    async function loadContent(type, url, loadingId, contentId, retryFn) {
        if (contentLoaders[type].loaded && !window.location.hash.includes('campaigns')) return;
        if (type === 'campaigns') contentLoaders[type].loaded = false;

        const loadingState = $(loadingId);
        const content = $(contentId);

        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Failed to load ${type}`);
            content.innerHTML = await response.text();
            rerunScripts(content);
            content.style.display = 'block';
            loadingState.style.display = 'none';
            contentLoaders[type].loaded = true;
            contentLoaders[type].callback?.();
        } catch (error) {
            console.error(`Error loading ${type}:`, error);
            loadingState.innerHTML = `
                <p style="color: var(--danger-color);">{{ translate("Failed to load content. Please try again.") }}</p>
                <button class="cta" onclick="${retryFn}">{{ translate("Retry") }}</button>
            `;
        }
    }

    const loadCampaigns = () => loadContent('campaigns', '/show_campaigns', '#campaignsLoadingState', '#campaignsContent', 'loadCampaigns()');
    const loadAddForm = () => loadContent('addForm', '/show_add_form', '#addFormLoadingState', '#addFormContent', 'loadAddForm()');
    const loadPendingEvents = () => loadContent('pending', '/show_pending_events', '#pendingLoadingState', '#pendingContent', 'loadPendingEvents()');

    function initializeCampaignListeners() {
        const campaignsSection = $('#campaigns');
        const backToAllBtn = $('#backToAllBtn');
        const allCategoryWrappers = $$('.campaign-category-wrapper');
        campaignsSection?.addEventListener('click', e => {
            if (!e.target.matches('.view-all-btn')) return;
            const categoryIdToShow = e.target.dataset.categoryId;
            allCategoryWrappers.forEach(wrapper => {
                const show = wrapper.dataset.categoryId === categoryIdToShow;
                wrapper.style.display = show ? 'block' : 'none';
                if (show) wrapper.querySelectorAll('.campaign-card.hidden').forEach(c => c.classList.remove('hidden'));
            });
            backToAllBtn.style.display = 'block';
            campaignsSection.scrollIntoView({ behavior: 'smooth' });
        });
        backToAllBtn?.addEventListener('click', () => {
            allCategoryWrappers.forEach(w => {
                w.style.display = 'block';
                w.querySelectorAll('.campaign-card').forEach((c, i) => i >= 4 && c.classList.add('hidden'));
            });
            backToAllBtn.style.display = 'none';
        });
    }

    function initializeAddFormListeners() {
        const form = $('#addEventForm');
        if (!form) return;
        form.addEventListener('submit', e => {
            e.preventDefault();
            e.target.dataset.url = '/addeventreq';
            handleFormSubmit(e.target, text => {
                if (text.includes('Please Login')) showSection('home');
                if (text.includes('Registered')) setTimeout(() => location.reload(), 4000);
            });
        });
        form.addEventListener('change', e => {
            const fd = new FormData();
            fd.append('field', e.target.name);
            fd.append('value', e.target.value);
            fetch('/save_draft', { method: 'POST', body: fd });
        });
    }

    function initializePendingListeners() {
        $$('.approve-btn').forEach(btn => {
            btn.addEventListener('click', e => {
                e.preventDefault();
                const row = btn.closest('tr');
                if (!row) return;
                const originalText = btn.textContent;
                btn.disabled = true;
                btn.textContent = '{{ translate("Processing...") }}';
                const formData = new FormData();
                row.querySelectorAll('input, select, textarea').forEach(input => {
                    formData.append(input.name, input.value);
                });
                fetch('/addevent', { method: 'POST', body: formData })
                .then(response => {
                    if (response.redirected) { window.location.href = response.url; return null; }
                    return response.text();
                })
                .then(text => {
                    if (text === null) return;
                    const isSuccess = text.toLowerCase().includes('success') ||
                                     text.toLowerCase().includes('approved') ||
                                     text.toLowerCase().includes('added');
                    showAlert(text, isSuccess ? 'success' : 'info');
                    if (isSuccess) {
                        row.style.opacity = '0';
                        setTimeout(() => { contentLoaders.pending.loaded = false; loadPendingEvents(); }, 1000);
                    } else {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('{{ translate("An error occurred.") }}', 'error');
                    btn.disabled = false;
                    btn.textContent = originalText;
                });
            });
        });
    }

    const handleFormSubmit = async (form, callback) => {
        const btn = form.querySelector('button[type="submit"]');
        const originalBtnText = btn.textContent;
        btn.disabled = true;
        btn.textContent = '{{ translate("Processing...") }}';
        try {
            const response = await fetch(form.dataset.url, { method: 'POST', body: new FormData(form) });
            const text = await response.text();
            const type = text.includes('Success') || text.includes('Registered') ? 'success' :
                         text.includes('Error') || text.includes('Invalid') ? 'error' : 'info';
            showAlert(text, type);
            callback?.(text);
        } catch (error) {
            showAlert('{{ translate("An error occurred.") }}', 'error');
            console.error(error);
        } finally {
            btn.disabled = false;
            btn.textContent = originalBtnText;
        }
    };

    const showSection = id => {
        const target = id || 'home';
        $$('.navlink').forEach(l => l.classList.toggle('active', l.dataset.section === target));
        $$('main > section').forEach(s => s.classList.toggle('active', s.id === target));
        window.scrollTo(0, 0);
        $('nav')?.classList.remove('active');
        if (target === 'campaigns') loadCampaigns();
        if (target === 'add') loadAddForm();
        if (target === 'pending') loadPendingEvents();
    };

    window.togglePasswordVisibility = id => {
        const field = $(`#${id}`);
        if (field) field.type = field.type === 'password' ? 'text' : 'password';
    };

    const addFormSubmitListener = (selector, url, callback) => {
        $(selector)?.addEventListener('submit', e => {
            e.preventDefault();
            e.target.dataset.url = url;
            handleFormSubmit(e.target, callback);
        });
    };

    let calendar;

    window.toggleView = function(view) {
        const listBtn = $('#listViewBtn');
        const calBtn = $('#calendarViewBtn');
        const listContent = $('#campaignsContent');
        const calContent = $('#calendarView');
        if (!contentLoaders.campaigns.loaded) loadCampaigns();
        if (view === 'list') {
            listBtn.classList.add('active'); calBtn.classList.remove('active');
            listContent.style.display = 'block'; calContent.style.display = 'none';
        } else {
            listBtn.classList.remove('active'); calBtn.classList.add('active');
            listContent.style.display = 'none'; calContent.style.display = 'block';
            if (!calendar) { initCalendar(); } else { setTimeout(() => calendar.render(), 100); }
        }
    };

    function initCalendar() {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listWeek' },
            events: function(info, successCallback, failureCallback) {
                fetch('/api').then(r => r.json()).then(data => {
                    const events = data['active events'].map(e => ({
                        title: e.eventname,
                        start: e.eventstartdate + (e.eventstarttime ? 'T' + e.eventstarttime : ''),
                        url: '#',
                        extendedProps: { description: e.description, location: e.location }
                    }));
                    successCallback(events);
                }).catch(failureCallback);
            },
            eventClick: function(info) {
                info.jsEvent.preventDefault();
                showAlert(`${info.event.title}\nüìç ${info.event.extendedProps.location}\nüìÖ ${info.event.start.toLocaleDateString()}`, 'info');
            }
        });
        calendar.render();
    }

    window.changetemplate = () => fetch("/changetemplate").then(() => location.reload());
    window.viewyourevents = username => fetch(`/viewyourevents/${username}`, { method: 'POST' })
        .then(() => { window.location.href = '#campaigns'; location.reload(); });
    window.sendsortreq = sortby => fetch(`/setsortby/${sortby}`, { method: 'POST' })
        .then(() => { window.location.href = '#campaigns'; location.reload(); });

    document.addEventListener('DOMContentLoaded', () => {
        const storedAlert = localStorage.getItem('showLanguageChangeAlert');
        if (storedAlert) {
            try {
                const alertData = JSON.parse(storedAlert);
                showAlert(alertData.message, 'success', 0, true);
                localStorage.removeItem('showLanguageChangeAlert');
            } catch (e) { console.error('Error parsing stored alert:', e); }
        }

        document.body.addEventListener('click', e => {
            if (e.target.matches('.navlink')) {
                e.preventDefault();
                showSection(e.target.dataset.section);
                location.hash = e.target.dataset.section;
            }
        });

        if (location.hash) { showSection(location.hash.slice(1)); }
        else { showSection('home'); }
        window.addEventListener('hashchange', () => showSection(location.hash.slice(1)));

        addFormSubmitListener('#loginpage', '/login', text => text.includes('Success') && location.reload());
        addFormSubmitListener('#signuppage', '/signup', text => text.includes('Success') && location.reload());

        $('.toggle-buttons')?.addEventListener('click', e => {
            if (e.target.tagName !== 'BUTTON') return;
            if (e.target.id === 'listViewBtn' || e.target.id === 'calendarViewBtn') return;
            const isLogin = e.target.id === 'login-tab-btn';
            $('#login-tab-btn').classList.toggle('active', isLogin);
            $('#signup-tab-btn').classList.toggle('active', !isLogin);
            $('#loginpage').classList.toggle('active', isLogin);
            $('#signuppage').classList.toggle('active', !isLogin);
        });

        $('#sendOtpBtn')?.addEventListener('click', async e => {
            const btn = e.target;
            const emailEl = $('#email');
            if (!emailEl.checkValidity()) { return showAlert("{{ translate('Please enter a valid email address.') }}", 'warning'); }
            btn.disabled = true;
            btn.textContent = "{{ translate('Sending...') }}";
            try {
                const fd = new FormData();
                fd.append('email', emailEl.value);
                const response = await fetch("/sendsignupotp", { method: "POST", body: fd });
                const text = await response.text();
                if (!response.ok) throw new Error(text || '{{ translate("Failed to send OTP.") }}');
                showAlert(text, 'info');
            } catch (err) {
                showAlert(err.message, 'error');
            } finally {
                setTimeout(() => { btn.disabled = false; btn.textContent = "{{ translate('Send OTP') }}"; }, 5000);
            }
        });

        const languageBtn = $('#languageBtn');
        const languageDropdown = $('#languageDropdown');

        if (languageBtn) {
            languageBtn.addEventListener('click', e => {
                e.stopPropagation();
                languageDropdown.style.display = languageDropdown.style.display === 'none' ? 'block' : 'none';
            });

            $$('.lang-option').forEach(option => {
                option.addEventListener('click', async e => {
                    const langCode = e.target.dataset.lang;
                    const langName = e.target.textContent;
                    localStorage.setItem('selectedLanguage', langCode);
                    try {
                        showAlert(`{{ translate("Please wait changing language to ") }} ${langName}...`, 'info', 0);
                        const response = await fetch(`/setlanguage/${langCode}`, { method: 'POST' });
                        if (!response.ok) throw new Error("{{ translate('Failed to set language') }}");
                        localStorage.setItem('showLanguageChangeAlert', JSON.stringify({
                            message: `{{ translate("Language changed to ") }} ${langName}. {{ translate("If not changed please try to reload the page or click the button below to reload!") }}`,
                            duration: 0
                        }));
                        window.location.reload();
                    } catch (err) {
                        showAlert('{{ translate("Could not change language right now. Please try again.") }}', 'error');
                        console.error(err);
                    }
                    languageDropdown.style.display = 'none';
                });
            });

            document.addEventListener('click', e => {
                if (!e.target.closest('.language-selector')) { languageDropdown.style.display = 'none'; }
            });
        }
    });
</script>
</body>
</html>
