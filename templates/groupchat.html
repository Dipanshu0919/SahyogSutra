<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Event Chat</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
    :root { --primary-color: #2563eb; --primary-hover: #2563eb; --bg-dark: #0f172a; --bg-light: #1e293b; --text-color: #f1f5f9; --text-muted: #94a3b8; --border-color: rgba(148,163,184,0.2); --radius: 12px; --font-main: 'Inter', sans-serif; }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: var(--font-main); background: var(--bg-dark); color: var(--text-color); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
    .chat-header { padding: 1rem 1.25rem; background: var(--bg-light); border-bottom: 1px solid var(--border-color); display: flex; align-items: center; gap: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); z-index: 10; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--primary-color); box-shadow: 0 0 8px var(--primary-color); animation: pulse 2s infinite; }
    .header-info h2 { font-size: 0.95rem; font-weight: 700; color: var(--text-color); line-height: 1.2; }
    .header-info p { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; font-weight: 600; }
    #grp-msgs { flex-grow: 1; overflow-y: auto; padding: 1.5rem; display: flex; flex-direction: column; gap: 1rem; background: var(--bg-dark); }
    #grp-msgs::-webkit-scrollbar { width: 6px; }
    #grp-msgs::-webkit-scrollbar-track { background: transparent; }
    #grp-msgs::-webkit-scrollbar-thumb { background: var(--bg-light); border-radius: 3px; }
    #grp-msgs::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
    .msg-wrapper { display: flex; max-width: 85%; animation: fadeIn 0.3s ease; gap: 10px; }
    .msg-content-stack { display: flex; flex-direction: column; max-width: 100%; }
    .profile-avatar { width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.85rem; font-weight: 700; color: white; flex-shrink: 0; text-transform: uppercase; background: #64748b; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
    .msg-bubble { padding: 8px 12px; border-radius: var(--radius); font-size: 0.9rem; line-height: 1.5; position: relative; word-wrap: break-word; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; min-width: 100px; }
    .msg-footer { font-size: 0.65rem; margin-top: 4px; align-self: flex-end; opacity: 0.8; white-space: nowrap; }
    .msg-username { font-size: 0.75rem; color: var(--primary-color); margin-bottom: 2px; text-decoration: none; font-weight: 600; cursor: pointer; transition: color 0.2s; align-self: flex-start; }
    .msg-username:hover { color: var(--primary-hover); text-decoration: underline; }
    .msg-wrapper.self { align-items: flex-end; align-self: flex-end; }
    .msg-wrapper.self .msg-bubble { background: var(--primary-color); color: white; border-top-right-radius: 2px; }
    .msg-wrapper.self .msg-footer { color: rgba(255, 255, 255, 0.9); }
    .msg-wrapper.other { align-items: flex-start; align-self: flex-start; flex-direction: row; }
    .msg-wrapper.other .msg-bubble { background: var(--bg-light); color: var(--text-color); border: 1px solid var(--border-color); border-top-left-radius: 2px; }
    .msg-wrapper.other .msg-footer { color: var(--text-muted); }
    .input-area { padding: 1rem; background: var(--bg-light); border-top: 1px solid var(--border-color); }
    #msg-form { position: relative; display: flex; align-items: center; width: 100%; }
    #grp-input { width: 100%; background: var(--bg-dark); border: 1px solid var(--border-color); color: var(--text-color); padding: 12px 50px 12px 20px; border-radius: 24px; font-size: 0.95rem; outline: none; transition: all 0.2s ease; font-family: var(--font-main); }
    #grp-input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); }
    #grp-input::placeholder { color: var(--text-muted); }
    .send-btn { position: absolute; right: 6px; background: var(--primary-color); border: none; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background 0.2s, transform 0.2s; color: white; }
    .send-btn:hover { background: var(--primary-hover); transform: scale(1.05); }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
</style>
</head>
<body>

<div class="chat-header">
    <div class="status-dot"></div>
    <div class="header-info">
        <h2>{{ eventname }}</h2>
        <p>ID: {{ eventid }}</p>
    </div>
</div>

<div id="grp-msgs">
    {% for u, m, t in messages %}
        {% if u == currentuname %}
            <div class="msg-wrapper self">
                <div class="msg-bubble">
                    <div class="msg-text">{{ m }}</div>
                    <div class="msg-footer">{{ t }}</div>
                </div>
            </div>
        {% else %}
            <div class="msg-wrapper other">
                <a href="/user/{{ u }}" target="_top">
                <div class="profile-avatar" data-username="{{ u }}">
                    {{ u[0] }}
                </div> </a>
                <div class="msg-content-stack">
                    <a href="/user/{{ u }}" class="msg-username" target="_top">{{ u }}</a>
                    <div class="msg-bubble">
                        <div class="msg-text">{{ m }}</div>
                        <div class="msg-footer">{{ t }}</div>
                    </div>
                </div>
            </div>
        {% endif %}
    {% endfor %}
</div>

<div class="input-area">
    <form id="msg-form" onsubmit="sendMessage(event)">
        <input type="hidden" id="eventid" value="{{ eventid }}">
        {% if currentuname == 'anonymous' %}
            <input type="text" id="grp-input" placeholder="Please log in to send messages." autocomplete="off" disabled>
            <button class="send-btn" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-lock-fill" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0a4 4 0 0 1 4 4v2.05a2.5 2.5 0 0 1 2 2.45v5a2.5 2.5 0 0 1-2.5 2.5h-7A2.5 2.5 0 0 1 2 13.5v-5a2.5 2.5 0 0 1 2-2.45V4a4 4 0 0 1 4-4m0 1a3 3 0 0 0-3 3v2h6V4a3 3 0 0 0-3-3"/>
                </svg>
            </button>
        {% else %}
        <input type="text" id="grp-input" placeholder="Type a message..." autocomplete="off">
        <button type="submit" class="send-btn">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="18" height="18">
                <path d="M3.478 2.405a.75.75 0 00-.926.94l2.432 7.905H13.5a.75.75 0 010 1.5H4.984l-2.432 7.905a.75.75 0 00.926.94 60.519 60.519 0 0018.445-8.986.75.75 0 000-1.218A60.517 60.517 0 003.478 2.405z" />
            </svg>
        </button>
        {% endif %}
    </form>
</div>

<script>
    const socket = io();
    const currentUser = "{{ currentuname }}";
    const msgContainer = document.getElementById('grp-msgs');

    function getAvatarColor(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            hash = str.charCodeAt(i) + ((hash << 5) - hash);
        }
        const hue = Math.abs(hash % 360);
        return `hsl(${hue}, 70%, 50%)`;
    }

    function colorizeAvatars() {
        document.querySelectorAll('.profile-avatar').forEach(avatar => {
            const username = avatar.getAttribute('data-username');
            if (username) {
                avatar.style.backgroundColor = getAvatarColor(username);
            }
        });
    }

    window.onload = () => {
        msgContainer.scrollTop = msgContainer.scrollHeight;
        colorizeAvatars();
    }

    socket.on("new_message", function(data) {
        if (data.eventid == "{{ eventid }}") {
            const isSelf = data.username === currentUser;
            const wrapper = document.createElement('div');
            wrapper.className = isSelf ? "msg-wrapper self" : "msg-wrapper other";
            
            if (isSelf) {
                wrapper.innerHTML = `
                    <div class="msg-bubble">
                        <div class="msg-text">${data.message}</div>
                        <div class="msg-footer">${data.time}</div>
                    </div>
                `;
            } else {
                const color = getAvatarColor(data.username);
                wrapper.innerHTML = `
                    <div class="profile-avatar" style="background-color: ${color}">
                        ${data.username.charAt(0).toUpperCase()}
                    </div>
                    <div class="msg-content-stack">
                        <a href="/user/${data.username}" class="msg-username" target="_top">${data.username}</a>
                        <div class="msg-bubble">
                            <div class="msg-text">${data.message}</div>
                            <div class="msg-footer">${data.time}</div>
                        </div>
                    </div>
                `;
            }
            
            msgContainer.appendChild(wrapper);
            msgContainer.scrollTop = msgContainer.scrollHeight;
        }
    });

    function sendMessage(e) {
        e.preventDefault();
        const input = document.getElementById('grp-input');
        const eventid = document.getElementById('eventid').value;
        const message = input.value;
        if (!message.trim()) return;

        socket.emit("add_grp_msg", { eventid: eventid, message: message, username: currentUser });
        input.value = ""; 
        input.focus();
    }
</script>
</body>
</html>